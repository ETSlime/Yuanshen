# 🧠 ETSlime ゲームエンジン開発ノート（日本語・詳細版）

> 本ドキュメントは、ETSlime による DirectX11 ベースのゲームエンジン開発内容を、モジュールごとに詳しく記録したものです。  
> 技術スタック：C++ / DirectX 11 / HLSL / Win32 / ImGui / Compute Shader

---

## 📚 目次

1. [レンダリングシステム](#レンダリングシステム)
2. [インスタンシング描画](#インスタンシング描画)
3. [アニメーションシステム](#アニメーションシステム)
4. [パーティクルシステム](#パーティクルシステム)
5. [地形・衝突管理](#地形衝突管理)
6. [モデル読み込みとキャッシュ](#モデル読み込みとキャッシュ)
7. [ライティングとスロット管理](#ライティングとスロット管理)
8. [シェーダー管理](#シェーダー管理)
9. [UI システム](#ui-システム)
10. [エフェクトシステム](#エフェクトシステム)
11. [ゲーム進行中枢](#ゲーム進行中枢)
12. [敵AIシステム](#敵AIシステム)

---

## レンダリングシステム

### 🎨 Forward Rendering
- Forward パスベースの描画。
- 複数のレンダリングパスに分離：
  - メインパス（Main Pass）
  - シャドウマップパス（Shadow Pass）
- 対応オブジェクトタイプ：
  - 静的モデル（Static Mesh）
  - スキンメッシュ（Skinned Mesh）
  - インスタンシング描画オブジェクト

### 🌘 シャドウマップシステム（CSM 対応）
- 最大4層までのカスケードシャドウマップに対応。
- LightViewProj 行列を自動計算。
- texel 単位での snap による精度調整。
- Debug 用 Frustum 可視化。
- ShadowMapRenderer が VS / Layout を自動切替。
- オブジェクトの AABB を用いたレベル選択と冗長アップロード対応。

---

## インスタンシング描画

### 🌱 対応オブジェクト
- 草（風で揺れる）
- 木（揺れ無し）
- 岩・花・茂み（今後対応予定）

### 🧩 技術的詳細
- オブジェクトごとに別の `InstanceBuffer` と `InputLayout` を使用。
- 草の頂点データは `GrassVertex` で、風揺れ用の `Weight` を保持。
- インスタンスごとにスケール・回転行列・位置情報を `InstanceData` に格納。
- アップロード方式：`D3D11_USAGE_DYNAMIC + Map/Unmap`。
- カリング済みデータは `SimpleArray<InstanceData>* visibleInstances` に格納。

### 🌀 LOD（Level of Detail）対応
- LOD レベルごとにバッファを分割管理。
- 各フレームでカメラとの距離から LOD レベルを自動決定。
- `DrawIndexedInstanced()` を LOD ごとに実行。

---

## アニメーションシステム
---

## モデル読み込みとアニメーション管理

### 📁 FBXLoader の実装
- 自作の `FBXLoader` により `.fbx`（ASCII形式）ファイルを直接パース。
- 頂点情報（Position, Normal, UV, Tangent 等）、インデックス、マテリアルを抽出。
- スケルトン構造：各ボーンに対する階層構造・親子関係を保持。
- アニメーションデータ：
  - ボーンごとのキーフレーム（位置・回転・スケール）を取得。
  - 複数のアニメーションクリップを `AnimClip` として格納。
  - 各 `AnimClip` に対して長さ、ループ属性、ブレンド用補間情報を保持。
- アニメーションクリップはアニメーションステートマシンに連携され、状態に応じて切り替え・ブレンド処理を実施。


### 🎭 状態遷移設計
- `AnimationStateMachine<State>` テンプレート構造。
- 列挙型 State による高速ステート管理。
- 各ステートにアニメーションデータ + 遷移条件 + 遷移後ステート + ブレンド時間保持。

### 🔄 遷移条件の実装
- 関数ポインタ（`bool (Character::*)() const`）で条件分岐。
- `GetNextState(ISkinnedMeshModelChar* character)` にキャラ参照を渡すことで、内部状態による判断可能。

### 💫 補間・ブレンド
- 直線補間：`XMVectorLerp`（位置）
- 球面線形補間：`XMQuaternionSlerp`（回転）
- ブレンド中のボーンマトリクス合成処理あり。

---

## パーティクルシステム

### 🔥 完全 GPU ベースの構成
- 全ての処理を Compute Shader により実装。
- 4段階パイプライン：
  - `EmitCS`: 粒子の生成
  - `UpdateCS`: 粒子の位置・速度・寿命更新
  - `SortCS`: 描画順用ソート（アルファ対応）
  - `DrawIndirect`: `IndirectArgs` による描画

### 🧠 粒子管理方式
- `FreeList` 構造：死亡した粒子の回収と空き SlotID の再利用。
- `g_FreeListConsumeUAV.Consume()` により動的割り当て。
- `spawnRate` による生成速度の統一制御。

### 🌈 機能一覧
- **フレームアニメーション（Texture Sheet / Flipbook）**
- **Cone 形状からの発射エリア制御**
- **Lifetime に応じたスケーリング・色変化**
- **SoftParticle 対応（カメラ距離によるフェード）**
- **DrawIndirect + GPU ソートによる高効率バッチ描画**

---

## 地形・衝突管理

### 🧱 Octree（八分木）による空間分割
- 地形三角形の高速クエリ処理を実現。
- 各ノードが AABB とポリゴンリスト保持。

### 🌾 草配置ロジック
- ランダムクラスター中心 + 半径内に複数草生成。
- クラスタ AABB → Octree → 近傍三角形リストを取得。
- Ray による地形交差点を取得して高さ決定。
- 三角形の法線に従って草を回転。
- 法線の傾斜角度によって設置を拒否。

---

## モデル読み込みとキャッシュ

### 📦 モデルマネージャ構成
- `ModelManager` / `SkinnedModelManager` で一元管理。
- `path + name` ハッシュで重複読み込み防止。

### 🚀 キャッシュシステム
- `.obj → .bin` 変換してバイナリ形式で高速ロード。
- モデルキャッシュローダにより初回のみパース処理。
- 将来的に `.fbx` にも対応予定。

---

## ライティングとスロット管理

### 🌞 対応ライト
- プレイヤー：移動可能な方向ライト（時間依存回転対応）
- 火：静止点光源（位置に追従）

### 🎯 TextureSlotManager による統一バインド
- 各テクスチャの slot をマクロ定義で固定：
  - g_Texture → t0
  - g_ShadowMap[x] → t1
  - g_NormalMap → t9 など
- ステート記録による冗長バインド回避を実現。

---

## シェーダー管理

### 🎮 ShaderManager クラス
- `ShaderID` による識別。
- `ShaderSet` / `ShadowShaderSet` / `ComputeShaderSet` 一元管理。
- `LoadAllShaders()` + `ReloadAllIfChanged()` によるホットリロード対応。

### 🔁 ホットリロード機能
- `(path, entry)` の組合せでハッシュ比較。
- shader blob の差異検出で部分コンパイル更新。
- `outputShaderPtr` を記録し多重解放を防止。

---

## UI システム

### 🖼 UIManager / UIElement
- UIElement: スプライト・テキスト・進捗バー等を包括。
- UIManager: 表示/非表示、更新管理、イベント制御。
- 描画用に `SetSprite()` 系関数群を多重定義。

---

## エフェクトシステム

### 🔥 FireEffectRenderer（火焔 + 煙）
- 火のアニメーションを Texture Sheet により再生。
- 煙は粒子システムで制御（火と同時または別表示可能）。
- モジュール単体で `Update()` + `Draw()` により動作。
- 柔らかい Blend モード対応、Additive/Alpha 設定可。

### 💡 今後の拡張：ShaderGroup 体系
- 複数のエフェクトをグループ単位でバッチ化。
- 共通の `ShaderSet` を活用し描画最適化。

---

## ゲーム進行中枢

### 🧠 GameSystem クラス
- タイトル・チュートリアル・ゲーム本編のモード管理。
- 各システム（Renderer、UI、Effect、EnemyManager等）の統括。
- ImGui による Debug ウィンドウ、CSM 設定切替、BoundingBox 表示制御。

---

## 敵AIシステム

### 👾 EnemyManager 管理
- 全ての敵キャラクターは `EnemyManager` により一元管理。
- 敵の生成、削除、更新、描画を一括制御。

### 🧠 行動制御：ビヘイビアツリー
- 各敵キャラは個別の `BehaviorTree` を所持。
- ノードタイプ：
  - `Selector` ノード：複数の行動から条件を満たす最初の子ノードを実行。
  - `Sequence` ノード：すべての子ノードを順番に評価、途中で失敗したら中断。
- 実装済みノード例：
  - プレイヤー発見 → 追跡 → 攻撃
  - パトロール → プレイヤー発見 → 移動 → 攻撃
- 条件判断はプレイヤーとの距離、視野角、遮蔽物の有無等に基づく。
- アニメーションと連携し、状態に応じて攻撃モーション・待機・移動アニメーションを再生。
